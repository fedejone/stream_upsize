# stream_upsize
Основной идеей реализации модуля **stream_upsize** , было реализовать выдачу данных методом указателя на то, в какой вектор значений должен быть помещен следующий пакет данных.

![](/doc/pointer.jpg)

Для этого был нужен простой счетчик и флаг сброса этого счетчика.
- Флаг сброса является флагом переполнения указателя, т.е. когда указатель заполнился, можно выдавать транзакцию мастеру

 Так как интерфейс модуля является урезанной шиной axi-stream, у него присутствует **рукопожатие valid и ready**.
- Для корректной записи данных, нужен флаг записи, активный **только тогда, когда со слейва приходит валид** и выходные данные были прочитаны мастером.
- Для корректной выдачи данных нужен флаг чтения, чтобы не выдавать данные мастеру когда он не готов
- Выходной **valid** будет выставлен только тогда, когда будет заполнен указатель или на вход придет сигнал last, иначе будут отданы данные не полной транзакции

![](/doc/full.jpg)
#
### Сигнал KEEP
Сигнал ***keep*** был реализован сдвиговым регистром, но с начальным состоянием всегда равным  первому биту, т.к, даже при единственном пакете в транзакции не будет некорректных данных. 
Он также должен быть сброшен при переполнении указателя или при сигнале ***Last*** 
#
При тестировании модуля с прерывающимся ***m_ready_i***, было замечено, что пропускная способность модуля при потоковых данных достаточно сильно страдает. И было принято решение **поставить на входе Fifo**.
Это позволит:
- Развязать сигналы valid и ready между модулем апсайзера и слейвом 
- Увеличит пропускную способность модуля, так как входной буффер позволит убрать зависимость готовности мастера и слейва, ведь на большем промежутке времени мастер может быть свободен а слейв занят и наоборот.
- Увеличит latency до 2, но в купе с увеличением пропускной способности, выигрыш окажется больше 
#
В качестве Fifo был взят готовый модуль из репозитория школы цифрового синтеза 
https://github.com/yuri-panchul/basics-graphics-music/tree/main/labs/90_valid_ready_etc_preview/16_ff_fifo_wrapped_in_valid_ready
с модулем связывания сигналов valid-ready и push-pop

## Пострчное комментирования модуля ***stream_upsize***
- 26-50 - входное фифо и связь сигналов моля с ним 
- 49-50 - т.к. взятое фифо не имеет поддержки сигнала last, он заходит и выходит вместе с данными, увеличивая разрядность данных фифо на 1 
- 60 - флаг записи указателя, активен при входном valid и если данные были прочитаны мастером 
- 61 - флаг чтения, активен при чтении мастером данных
- 62- флаг конца указателя 
- 63 - ***ready*** на фифо активен для чтения данных, только при свободном указателе 
-  64 - ***valid*** мастеру, активен тогда, когда указатель заполнил вектор 
-  67-74 - логика указателя, так же описана выше 
-  77-84 - логика ***keep_r*** , сдвиговый регистр со сбросом при переполнении указателя или при сигнале ***last*** 
- 87-94 - регистр ***full_bank***  высокий уровень указывает на то, что указатель выставил данные для чтения, низкий уровень только после прочтения мастером данных
- 97-105 - логика присвоения вектору выходных данных, входных данных, в зависимости от указателя
- 108-109 - выходные регистры сигналов ***Keep*** и ***last***

#
- Код проекта находится в папке *RTL*

- Тестбенч модуля находится в папке *tb*

- Скрипт для запуска симуляции проекта находится в папке *sim\modelsim\stream_upsize\make_sim.bat*

- Скрипт для запуска синтеза проекта находится в папке  *syn\Vivado\make_analyz.bat*
